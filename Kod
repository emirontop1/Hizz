<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karne GÃ¶rÃ¼ntÃ¼leme Paneli (Nihai SÃ¼rÃ¼m)</title>

    <style>
        /* CSS Stilleri */
        body {
            margin: 0;
            background: #f0f2f5;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .control-panel {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1100px;
            justify-content: center;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        input {
            padding: 10px;
            width: 150px;
            border-radius: 4px;
            border: 1px solid #aaa;
        }

        button {
            padding: 11px 20px;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        #btnGoster { background: #28a745; }
        #btnGoster:hover { background: #218838; }

        #btnBul { background: #007bff; }
        #btnBul:hover { background: #0056b3; }

        #btnOtoAra { background: #ffc107; color: #333; }
        #btnOtoAra:hover { background: #e0a800; }
        
        /* SonuÃ§ Konteynerleri */
        .result-container {
            width: 100%;
            max-width: 1100px;
            min-height: 50px; 
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        #errorContainer {
            background: #f8d7da; 
            border: 1px solid #f5c6cb;
            color: #721c24;
            margin-top: 10px;
        }

        /* DaraltÄ±labilir (Accordion) Stili */
        details {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        /* Ana SÄ±nÄ±f BaÅŸlÄ±ÄŸÄ± (Section) Stili */
        #pdfContainer > details {
            margin-bottom: 20px;
            background: #f0f0f0; 
            border-left: 5px solid #007bff;
        }

        #pdfContainer > details > summary {
            background-color: #e0e0e0; 
            font-size: 1.1em;
            padding: 15px 10px;
        }

        /* Ã–ÄŸrenci listesi iÃ§in iÃ§ iÃ§e details stili */
        .class-student-list > details {
             margin: 5px 0 5px 0px; 
             border: none;
             border-bottom: 1px solid #eee;
        }
        .class-student-list > details:last-child {
             border-bottom: none;
        }

        .class-student-list > details > summary {
            background-color: #fff;
            font-weight: normal;
            padding: 10px; 
        }

        summary {
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            list-style: none; 
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        summary::-webkit-details-marker { display: none; }
        summary::before {
            content: "â–¶";
            display: inline-block;
            margin-right: 10px;
            transition: transform 0.2s;
            color: #28a745; 
        }

        details[open] > summary:before {
            content: "â–¼";
        }
        
        .pdf-content {
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .pdf-info {
            flex-grow: 1;
            font-weight: bold;
        }

        .render-button {
            padding: 5px 10px;
            margin-left: 10px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .render-button:hover {
            background: #138496;
        }

        canvas {
            width: 100%;
            display: block;
            margin-top: 10px;
            border: 1px solid #ddd;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
</head>

<body>

    <div class="control-panel">
        <div class="form-group">
            <label for="denemeID">Deneme ID</label>
            <input type="number" id="denemeID" placeholder="Ã–rn: 747" value="747">
        </div>
        
        <div class="form-group">
            <label for="kurumKodu">Kurum Kodu</label>
            <input type="number" id="kurumKodu" placeholder="Ã–rn: 745343">
        </div>

        <div class="form-group">
            <label for="ogrenciNo">Ã–ÄŸrenci No</label>
            <input type="number" id="ogrenciNo" placeholder="Ã–rn: 188">
        </div>
        
        <div class="form-group">
            <label for="parallelLimit">Paralel Ä°stek Limiti</label>
            <input type="number" id="parallelLimit" value="5" min="1" max="20">
        </div>

        <button id="btnGoster" onclick="karneGetir()">Karne GÃ¶rÃ¼ntÃ¼le (Tek)</button>
        <button id="btnOtoAra" onclick="otomatikAramaBaslat()">Otomatik Ara (1-1000)</button>
        <button id="btnBul" onclick="kurumKoduBul()">Kurum Kodu Bul</button>
    </div>
    
    <div id="status"></div> 
    
    <div id="pdfContainer" class="result-container">
        <h2 id="pdfContainerTitle">âœ… BaÅŸarÄ±lÄ± PDF SonuÃ§larÄ±</h2>
        <p id="initialMessage">Arama sonuÃ§larÄ± sÄ±nÄ±flara gÃ¶re anlÄ±k ve dinamik olarak listelenecektir.</p>
    </div>
    
    <div id="errorContainer" class="result-container">
        <h2>âŒ PDF Bulunamayanlar</h2>
        <p>Bulunamayan veya hatalÄ± PDF'ler burada listelenecektir.</p>
    </div>


    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        /* *** GÃœÃ‡LÃœ Ä°SÄ°M OKUMA VE GRUPLAMA REGEX'leri (NEGATÄ°F LÄ°STE GENÄ°ÅLETÄ°LDÄ°!) *** */
        const NAME_REGEX = /(?:AdÄ± SoyadÄ±:|Ã–ÄŸrenci AdÄ±:)\s*([^\n\r]+)|(?!(Ã–ÄRENCÄ°|SINAV|SONUÃ‡|BELGESÄ°|DENÄ°ZLÄ°|ORTAOKULU|GELÄ°ÅÄ°M|DEÄERLENDÄ°RME|SINIF|ATATÃœRK|ACIPAYAM|TG))\b([A-ZÃ‡ÄÄ°Ã–ÅÃœ\s]{4,})/g; 
        const CLASS_REGEX = /(?:SÄ±nÄ±fÄ±:|SÄ±nÄ±f:)\s*([^\s]+)|(\d+\/[A-ZÃ‡ÄÄ°Ã–ÅÃœ\s]{1,3}\s*(?:-\s*\d{1,3})?)/i;
        const STUDENT_NO_REGEX = /(?:Ã–ÄŸrenci No:|Okul No:)\s*(\d+)|(\s\d{2,5}\s)/i; 


        // PDF'ten metin Ã§Ä±karma (page.getPage hatasÄ± dÃ¼zeltildi)
        async function extractTextFromPdf(pdfBuffer) {
            try {
                const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
                let fullText = "";
                const page = await pdf.getPage(1); 
                const textContent = await page.getTextContent(); 
                fullText = textContent.items.map(s => s.str).join(" ").replace(/\s+/g, ' ') + " "; 
                return fullText;
            } catch (error) {
                console.error("PDF'ten metin Ã§Ä±karÄ±lÄ±rken hata:", error);
                return null;
            }
        }

        // Metinden isim ve sÄ±nÄ±fÄ± bulma
// ... (DiÄŸer deÄŸiÅŸkenler ve extractTextFromPdf fonksiyonu aynÄ± kalÄ±r)

// Metinden isim ve sÄ±nÄ±fÄ± bulma (GeliÅŸtirilmiÅŸ REGEX'ler kullanÄ±lÄ±yor)
function parseNameAndClass(text, oNo) {
    
    // YENÄ° VE GÃœÃ‡LÃœ NAME_REGEX
    // 1. Etiketli isim (AdÄ± SoyadÄ±: RAMAZAN DUMAN)
    // 2. Etiketsiz, ancak hemen ardÄ±ndan sÄ±nÄ±f bilgisi gelen isim (RAMAZAN DUMAN 8/B-23)
    const NAME_REGEX_STRICT = /(?:AdÄ± SoyadÄ±:|Ã–ÄŸrenci AdÄ±:)\s*([A-ZÃ‡ÄÄ°Ã–ÅÃœ\s]{2,})|([A-ZÃ‡ÄÄ°Ã–ÅÃœ\s]{4,})\s+\d+\/[A-ZÃ‡ÄÄ°Ã–ÅÃœ\s]{1,3}/g; 
    
    let name = 'Bilinmiyor';
    
    const matches = [...text.matchAll(NAME_REGEX_STRICT)];
    
    for (const match of matches) {
        let potentialName = match[1] || match[2]; // match[1] etiketli, match[2] etiketsiz isimdir.

        if (potentialName) {
            potentialName = potentialName.trim().replace(/\s+/g, ' ').replace(/[|]/g, '');

            // Kriter 1: Ã‡ok kÄ±sa metinler veya sadece rakam olanlarÄ± ele
            if (potentialName.length < 5 || /^\d+$/.test(potentialName)) {
                continue;
            }
            
            // Kriter 2: Okul, SÄ±nav, Belgesi gibi baÅŸlÄ±klarÄ± ele
            const excludedWords = ["BELGESÄ°", "OKULU", "ORTAOKULU", "SINAV", "SONUÃ‡", "GELÄ°ÅÄ°M", "DEÄERLENDÄ°RME", "DENÄ°ZLÄ°", "ACIPAYAM"];
            if (excludedWords.some(word => potentialName.toUpperCase().includes(word))) {
                continue;
            }
            
            // Ä°sim bulunduÄŸunda dÃ¶ngÃ¼yÃ¼ kÄ±r
            // Sadece ilk harfleri bÃ¼yÃ¼k yap
            name = potentialName.toLowerCase().split(' ').map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
            break;
        }
    }

    // Ek Temizlik AdÄ±mÄ±: Ã–ÄŸrenci NumarasÄ±nÄ± isimden ayÄ±r
    if (name.includes(oNo)) {
        name = name.replace(oNo, '').trim();
    }
    
    // Son Kontrol
    if (name.length < 3) {
        name = 'Bilinmiyor (Format HatasÄ±)';
    }
        
    // ----------------------------------------------------
    // SÄ±nÄ±f ve Ã–ÄŸrenci No Ã‡Ä±karÄ±mÄ± (Ã–nceki hali korunur)
    // ----------------------------------------------------
    const CLASS_REGEX = /(?:SÄ±nÄ±fÄ±:|SÄ±nÄ±f:)\s*([^\s]+)|(\d+\/[A-ZÃ‡ÄÄ°Ã–ÅÃœ\s]{1,3}\s*(?:-\s*\d{1,3})?)/i;
    const STUDENT_NO_REGEX = /(?:Ã–ÄŸrenci No:|Okul No:)\s*(\d+)|(?:\s(\d{2,5})\s)/i;

    let classMatch = text.match(CLASS_REGEX);
    let className = 'Bilinmiyor';
    if (classMatch) {
        className = classMatch[1] ? classMatch[1].trim() : (classMatch[2] ? classMatch[2].trim() : 'Bilinmiyor');
    }
    
    let studentNoMatch = text.match(STUDENT_NO_REGEX);
    let studentNo = oNo; 
    if (studentNoMatch) {
        studentNo = studentNoMatch[1] ? studentNoMatch[1].trim() : (studentNoMatch[2] ? studentNoMatch[2].trim() : oNo);
    }
    studentNo = studentNo.replace(/\s/g, '');
    
    // SINIF GRUPLAMA SADELEÅTÄ°RME MANTIÄI
    className = className.toUpperCase().replace(/\s/g, '').replace(/\//g, '/');
    const dashIndex = className.indexOf('-');
    if (dashIndex !== -1) {
         className = className.substring(0, dashIndex);
    }
    
    return { 
        name: name, 
        className: className, 
        studentNo: studentNo 
    };
}

// ... (Geri kalan tÃ¼m fonksiyonlar (karneGetir, otomatikAramaBaslat vb.) deÄŸiÅŸmeden aynÄ± kalacaktÄ±r)
        // GÃ¶rÃ¼ntÃ¼leme iÃ§in sÄ±nÄ±f adÄ±nÄ± gÃ¼zelleÅŸtirir
        function formatClassName(className) {
            if (className.includes("BÄ°LÄ°NMÄ°YOR")) {
                return "Bilinmiyor / Hata";
            }
            const match = className.match(/^(\d+)\/([A-ZÃ‡ÄÄ°Ã–ÅÃœ]+)$/i);
            if (match) {
                return `${match[1]} / ${match[2]} SÄ±nÄ±fÄ±`;
            }
            return `${className} SÄ±nÄ±fÄ±`;
        }


        // PDF'i render eden yardÄ±mcÄ± fonksiyon
        async function renderPDFToElement(pdfBuffer, targetElement) {
            try {
                const pdf = await pdfjsLib.getDocument({ data: pdfBuffer }).promise;
                targetElement.innerHTML = ''; 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    targetElement.appendChild(canvas);

                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise;
                }
                return true;
            } catch (err) {
                targetElement.innerHTML = `<p style="color:red;">Render HatasÄ±: ${err.message}</p>`;
                return false;
            }
        }

        /**
         * Yeni Ã¶ÄŸrenciyi anlÄ±k olarak ilgili sÄ±nÄ±fa ekler ve sÄ±ralamasÄ±nÄ± korur.
         */
        function renderSingleStudent(student) {
            const container = document.getElementById("pdfContainer");
            
            // 1. Gruplama ve GÃ¶rÃ¼ntÃ¼leme Ä°simlerini HazÄ±rla
            const rawClassName = student.className.includes("BÄ°LÄ°NMÄ°YOR") ? "Bilinmiyor/Hata" : student.className;
            const displayClassName = formatClassName(rawClassName);
            
            const classId = `class-${rawClassName.replace(/[^a-zA-Z0-9]/g, '-')}`; 

            // 2. SÄ±nÄ±f BaÅŸlÄ±ÄŸÄ±nÄ± (details - Section) Bul veya OluÅŸtur
            let classSection = document.getElementById(classId);
            if (!classSection) {
                classSection = document.createElement('details');
                classSection.id = classId;
                classSection.open = true; 
                classSection.dataset.className = rawClassName; 
                
                const summary = document.createElement('summary');
                summary.innerHTML = `<strong>SÄ±nÄ±f: ${displayClassName}</strong> (Yeni)`; 
                classSection.appendChild(summary);

                const studentList = document.createElement('div');
                studentList.className = 'class-student-list';
                classSection.appendChild(studentList);

                insertSortedClass(classSection, container);
                
                const initialMessage = document.getElementById('initialMessage');
                if (initialMessage) initialMessage.style.display = 'none';
            }

            // 3. Ã–ÄŸrenci Elementlerini OluÅŸtur
            const studentDetails = document.createElement('details');
            studentDetails.dataset.studentNo = student.studentNo; 
            
            const studentSummary = document.createElement('summary');
            
            const infoSpan = document.createElement('span');
            infoSpan.className = 'pdf-info';
            // Ä°sim ve Ã–ÄŸrenci No'yu gÃ¶ster
            infoSpan.textContent = `âœ… ${student.name} - Ã–ÄŸrenci No: ${student.studentNo}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'pdf-content';
            
            studentSummary.appendChild(infoSpan);
            
            studentDetails.appendChild(studentSummary);
            studentDetails.appendChild(contentDiv);
            
            // Detay aÃ§Ä±ldÄ±ÄŸÄ±nda PDF'i render et
            studentDetails.addEventListener('toggle', function() {
                if (this.open && contentDiv.children.length === 0) {
                    renderPDFToElement(student.pdfBuffer.slice(0), contentDiv);
                }
            });


            // 4. Ã–ÄŸrenciyi SÄ±nÄ±f Listesine SÄ±ralÄ± Ekle
            const studentListContainer = classSection.querySelector('.class-student-list');
            insertSortedStudent(studentDetails, studentListContainer);

            // 5. Dinamik Bilgileri GÃ¼ncelle
            updateClassCount(classSection, displayClassName);
        }
        
        // SÄ±nÄ±f baÅŸlÄ±klarÄ±nÄ± alfabetik/sayÄ±sal sÄ±raya gÃ¶re yerleÅŸtirir.
        function insertSortedClass(newClassSection, container) {
            const newClassName = newClassSection.dataset.className;
            let inserted = false;

            const existingClassSections = Array.from(container.children).filter(el => el.tagName === 'DETAILS');

            for (const existingSection of existingClassSections) {
                const existingClassName = existingSection.dataset.className;
                
                if (newClassName.localeCompare(existingClassName, 'tr', { numeric: true }) < 0) {
                    container.insertBefore(newClassSection, existingSection);
                    inserted = true;
                    break;
                }
            }

            if (!inserted) {
                container.appendChild(newClassSection);
            }
        }
        
        // Ã–ÄŸrenci elementini Ã¶ÄŸrenci numarasÄ±na gÃ¶re sÄ±ralÄ± ekler
        function insertSortedStudent(newStudentDetails, listContainer) {
            const newStudentNo = parseInt(newStudentDetails.dataset.studentNo);
            let inserted = false;

            const existingStudents = Array.from(listContainer.children).filter(el => el.tagName === 'DETAILS');
            
            for (const existingStudent of existingStudents) {
                const existingStudentNo = parseInt(existingStudent.dataset.studentNo);
                
                if (newStudentNo < existingStudentNo) {
                    listContainer.insertBefore(newStudentDetails, existingStudent);
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) {
                listContainer.appendChild(newStudentDetails);
            }
        }

        // SÄ±nÄ±f baÅŸlÄ±ÄŸÄ±ndaki Ã¶ÄŸrenci sayÄ±sÄ±nÄ± gÃ¼nceller
        function updateClassCount(classSection, displayClassName) {
            const listContainer = classSection.querySelector('.class-student-list');
            const count = listContainer ? listContainer.children.length : 0;
            const summary = classSection.querySelector('summary');
            if (summary) {
                summary.innerHTML = `<strong>SÄ±nÄ±f: ${displayClassName}</strong> (${count} Ã–ÄŸrenci)`;
            }
        }


        // --- Ana Fonksiyonlar (Otomatik Arama, Tekli GÃ¶sterim, Kurum Kodu Bul) ---

        // Tekli gÃ¶rÃ¼ntÃ¼leme
        async function karneGetir() {
            const dID = document.getElementById("denemeID").value;
            const kKodu = document.getElementById("kurumKodu").value;
            const oNo = document.getElementById("ogrenciNo").value;
            const container = document.getElementById("pdfContainer");
            const statusDiv = document.getElementById("status");
            document.getElementById("errorContainer").innerHTML = '<h2>âŒ PDF Bulunamayanlar</h2>';
            container.innerHTML = "<h2>âœ… BaÅŸarÄ±lÄ± PDF SonuÃ§larÄ±</h2>"; 

            if (!dID || !kKodu || !oNo) {
                alert("LÃ¼tfen Deneme ID, Kurum Kodu ve Ã–ÄŸrenci No bilgilerini doldurun.");
                return;
            }

            statusDiv.innerHTML = "PDF YÃ¼kleniyor ve Metin Ã‡Ä±karÄ±lÄ±yor...";
            const pdfURL = `https://www.hizlideneme.com/ogrenci_giris/karne_pdf/${dID}/${oNo}/${kKodu}`;

            try {
                const response = await fetch(pdfURL);
                if (!response.ok) {
                    container.innerHTML = `<p style="color:red;">PDF bulunamadÄ± veya sunucu hatasÄ±! (Ã–ÄŸrenci No: ${oNo})</p>`;
                    statusDiv.innerHTML = "Hata.";
                    return;
                }
                const pdfBuffer = await response.arrayBuffer();
                
                const text = await extractTextFromPdf(pdfBuffer);
                const { name, className } = parseNameAndClass(text, oNo);

                if (text) {
                    statusDiv.innerHTML = `**Ã–ÄŸrenci: ${name}, SÄ±nÄ±f: ${className}** (Ã–ÄŸrenci No: ${oNo})`;
                } else {
                    statusDiv.innerHTML = `Metin Ã§Ä±karÄ±lamadÄ± veya PDF boÅŸ.`;
                }
                
                await renderPDFToElement(pdfBuffer, container);

            } catch (err) {
                console.error(err);
                container.innerHTML = "<h2>âœ… BaÅŸarÄ±lÄ± PDF SonuÃ§larÄ±</h2>" + "<p style='color:red;'>PDF yÃ¼klenirken veya iÅŸlenirken hata oluÅŸtu!</p>";
                statusDiv.innerHTML = "Hata.";
            }
        }

        // Otomatik Arama Ä°ÅŸlevi
        async function otomatikAramaBaslat() {
            const dID = document.getElementById("denemeID").value;
            const kKodu = document.getElementById("kurumKodu").value;
            const errorContainer = document.getElementById("errorContainer"); 
            const statusDiv = document.getElementById("status");
            const container = document.getElementById("pdfContainer");
            const parallelLimit = parseInt(document.getElementById("parallelLimit").value);

            const startNo = 1;
            const endNo = 1000;
            let bulunanSayisi = 0;
            let hataSayisi = 0;
            let islenenSayisi = 0;
            let siradakiOgrenciNo = startNo;
            
            if (!dID || !kKodu) {
                alert("LÃ¼tfen Deneme ID ve Kurum Kodu bilgilerini doldurun.");
                return;
            }
            
            container.innerHTML = `<h2 id="pdfContainerTitle">âœ… BaÅŸarÄ±lÄ± PDF SonuÃ§larÄ±</h2><p id="initialMessage">Arama sonuÃ§larÄ± sÄ±nÄ±flara gÃ¶re anlÄ±k ve dinamik olarak listelenecektir.</p>`;
            errorContainer.innerHTML = '<h2>âŒ PDF Bulunamayanlar</h2>';
            statusDiv.innerHTML = 'Arama BaÅŸlatÄ±ldÄ±...';

            document.getElementById("btnOtoAra").disabled = true;
            document.getElementById("btnGoster").disabled = true;

            const activePromises = new Set(); 
            
            const processNextPdf = async () => {
                if (siradakiOgrenciNo > endNo && activePromises.size === 0) {
                    statusDiv.innerHTML = `Arama TamamlandÄ±! **1'den ${endNo}'a kadar** toplam **${bulunanSayisi}** baÅŸarÄ±lÄ± PDF, **${hataSayisi}** baÅŸarÄ±sÄ±z PDF iÅŸlendi. SonuÃ§lar **sÄ±nÄ±flara gÃ¶re gruplandÄ±rÄ±ldÄ±.**`;
                    
                    document.getElementById("btnOtoAra").disabled = false;
                    document.getElementById("btnGoster").disabled = false;
                    return;
                }

                if (siradakiOgrenciNo <= endNo && activePromises.size < parallelLimit) {
                    const currentONo = siradakiOgrenciNo++;
                    islenenSayisi++;
                    statusDiv.innerHTML = `Ä°ÅŸleniyor: **${islenenSayisi}/${endNo}** (Bulunan: ${bulunanSayisi}, Hata: ${hataSayisi}, Paralel Ä°stek: ${activePromises.size}/${parallelLimit})`;

                    const pdfURL = `https://www.hizlideneme.com/ogrenci_giris/karne_pdf/${dID}/${currentONo}/${kKodu}`;

                    const promise = (async () => {
                        let pdfBuffer = null;
                        
                        try {
                            const response = await fetch(pdfURL);
                            
                            if (response.ok) {
                                pdfBuffer = await response.arrayBuffer();
                                
                                const text = await extractTextFromPdf(pdfBuffer);
                                
                                if (text) {
                                    const studentData = parseNameAndClass(text, currentONo);
                                    
                                    renderSingleStudent({ ...studentData, pdfBuffer }); 
                                    bulunanSayisi++;
                                    
                                } else {
                                    const errorItem = document.createElement('p');
                                    errorItem.innerHTML = `âš ï¸ Ã–ÄŸrenci No: **${currentONo}** - PDF yÃ¼klendi ancak metin Ã§Ä±karÄ±lamadÄ± (Hata Kodu 1).`;
                                    errorContainer.appendChild(errorItem);
                                    hataSayisi++;
                                }

                            } else {
                                const errorItem = document.createElement('p');
                                errorItem.innerHTML = `âŒ Ã–ÄŸrenci No: **${currentONo}** - PDF BulunamadÄ± (${response.status || 'AÄŸ HatasÄ±'}).`;
                                errorContainer.appendChild(errorItem);
                                hataSayisi++;
                            }
                        } catch (err) {
                            const errorItem = document.createElement('p');
                            errorItem.innerHTML = `ğŸ›‘ Ã–ÄŸrenci No: **${currentONo}** - YÃ¼klenirken/Ä°ÅŸlenirken Hata: ${err.message}.`;
                            errorContainer.appendChild(errorItem);
                            hataSayisi++;
                        } finally {
                            activePromises.delete(promise); 
                            processNextPdf(); 
                        }
                    })();
                    activePromises.add(promise);
                    processNextPdf(); 
                }
            };

            for (let i = 0; i < parallelLimit; i++) {
                processNextPdf();
            }
        }


        function kurumKoduBul() {
            window.open("https://mebbis.meb.gov.tr/kurumlistesi.aspx", "_blank");
        }
    </script>

</body>
</html>
